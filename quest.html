<script>
  const userId = localStorage.getItem('userId');
  if (!userId) {
    alert("로그인이 필요합니다.");
    window.location.href = 'login.html';
    throw new Error("로그인 필요");
  }

  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRS1ON6xB6DY-t8v21KQLsM3XnfoidHRVaPVJQQB09Cmf8V7rm_aXJmqRXZGoMelVamV8jG6T9awtXU/pub?output=csv';

  fetch(CSV_URL)
    .then(res => res.text())
    .then(csv => {
      const lines = csv.trim().split('\n').map(line => line.split(',').map(c => c.trim()));
      const header = lines[0];
      const data = lines.slice(1);

      const useridIdx = header.indexOf('userid');
      const questIdIdx = header.indexOf('questId');
      const contentIdx = header.indexOf('내용');
      const rewardIdx = header.indexOf('보상');
      const checkIdx = header.indexOf('check');

      const tbody = document.querySelector('#questTable tbody');
      let first = true;

      // 로그인한 사용자의 데이터만 필터링
      const userQuests = data.filter(row => row[useridIdx] === userId);

      userQuests.forEach(row => {
        const questId = row[questIdIdx];
        const content = row[contentIdx];
        const reward = row[rewardIdx];
        const done = (row[checkIdx] || '').toLowerCase() === 'true';

        if (!first) {
          const sep = document.createElement('tr');
          sep.className = 'separator-row';
          const td = document.createElement('td');
          td.colSpan = 4;
          td.textContent = '▽';
          sep.appendChild(td);
          tbody.appendChild(sep);
        }
        first = false;

        const tr = document.createElement('tr');
        if (done) tr.classList.add('completed');
        tr.innerHTML = `
          <td>${questId || '-'}</td>
          <td>${content || '-'}</td>
          <td>${reward || '-'}</td>
          <td>${done ? 'O' : 'X'}</td>
        `;
        tbody.appendChild(tr);
      });

      if (userQuests.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">퀘스트가 없습니다.</td></tr>`;
      }
    })
    .catch(err => {
      console.error('CSV 불러오기 오류:', err);
      alert('퀘스트를 가져오는 데 실패했습니다.');
    });
</script>
